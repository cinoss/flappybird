// Generated by CoffeeScript 1.7.1
'use strict';
var MainCtrl;

window.requestAnimateFrame = (function(callback) {
  return window.requestAnimationFrame || window.webkitRequestAnimationFrame || window.mozRequestAnimationFrame || window.oRequestAnimationFrame || window.msRequestAnimationFrame || function(callback) {
    return window.setTimeout(callback, 1000 / 60);
  };
})();

MainCtrl = function($scope, $timeout) {
  var bird, flap, freePairs, onFrame, pipe, pixel, stage, startTime, theta;
  pipe = {
    distance: 56,
    gap: 51,
    width: 28,
    topHeight: 11
  };
  stage = {
    g: 300,
    height: pipe.gap * 4,
    width: (pipe.distance + pipe.width) * 2
  };
  bird = {
    size: 20,
    pos: {
      x: 0,
      y0: stage.height / 2,
      y: stage.height / 2
    },
    v: {
      x: 100,
      y: 0,
      y0: 130
    },
    screenX: pipe.distance
  };
  bird.radius = bird.size / 2;
  pixel = {
    size: 2
  };
  $('#bird').css('height', (bird.size * pixel.size) + 'px');
  $('#bird').css('width', (bird.size * pixel.size) + 'px');
  $('#bird').css('top', (bird.pos.y * pixel.size - bird.radius) + 'px');
  $('#bird').css('left', (bird.screenX * pixel.size - bird.radius) + 'px');
  $('.pipe').css('width', (pipe.width * pixel.size) + 'px');
  $('.pipe').css('height', (stage.height * pixel.size) + 'px');
  $('.pipe.up').css('top', (pipe.gap * pixel.size) + 'px');
  $('.pipe.down').css('top', -1 * (stage.height * pixel.size) + 'px');
  $('#stage').css('height', (stage.height * pixel.size) + 'px');
  $('#stage').css('width', (stage.width * pixel.size) + 'px');
  freePairs = $('.pair');
  startTime = (new Date()).getTime();
  theta = function(dx, dy) {
    var t;
    t = dy / (Math.abs(dx) + Math.abs(dy));
    if (t > 0) {
      return t * 90;
    } else {
      return 360 + t * 90;
    }
  };
  onFrame = function($scope, repeat) {
    var angle, currentTime, lastTime, t;
    currentTime = (new Date()).getTime();
    t = (currentTime - startTime) / 1000;
    bird.pos.y = bird.pos.y0 + bird.v.y * t + 0.5 * stage.g * Math.pow(t, 2);
    lastTime = currentTime;
    $('#bird').css('top', (bird.pos.y * pixel.size - bird.radius) + 'px');
    angle = theta(bird.v.x, bird.v.y + t * stage.g);
    $('#bird').css('transform', 'rotate(' + angle + 'deg)');
    $('#bird').css('-ms-transform', 'rotate(' + angle + 'deg)');
    $('#bird').css('-webkit-transform', 'rotate(' + angle + 'deg)');
    $('#bird').css('top', (bird.pos.y * pixel.size - bird.radius) + 'px');
    if (repeat) {
      if (bird.pos.y > stage.height - bird.radius) {
        flap();
        bird.pos.y0 = stage.height / 2;
      }
      requestAnimateFrame(function() {
        onFrame($scope, true);
      });
    }
  };
  flap = function() {
    if (bird.pos.y > bird.radius) {
      onFrame($scope, false);
      startTime = (new Date()).getTime();
      bird.pos.y0 = bird.pos.y;
      return bird.v.y = -bird.v.y0;
    }
  };
  $('#stage').click(flap);
  $(document).keydown(function(event) {
    return flap();
  });
  onFrame($scope, true);
};
