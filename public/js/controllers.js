// Generated by CoffeeScript 1.7.1
'use strict';
var MainCtrl, PipeManager, bird, flap, freePairs, onFrame, pipe, pipeMan, pixel, stage, startTime, theta;

window.requestAnimateFrame = (function(callback) {
  return window.requestAnimationFrame || window.webkitRequestAnimationFrame || window.mozRequestAnimationFrame || window.oRequestAnimationFrame || window.msRequestAnimationFrame || function(callback) {
    return window.setTimeout(callback, 1000 / 60);
  };
})();

PipeManager = (function() {
  function PipeManager(maxY, nextX, step, freePairs) {
    this.maxY = maxY;
    this.nextX = nextX;
    this.step = step;
    this.freePairs = freePairs;
    this.pipes = [];
  }

  PipeManager.prototype.genPipe = function() {
    var pipe;
    console.log('genPipe');
    pipe = {
      y: Math.round(Math.random() * this.maxY),
      x: this.nextX,
      pair: this.freePairs.pop()
    };
    console.log(pipe.pair);
    $("#" + pipe.pair.id).css('top', pipe.y * pixel.size);
    this.nextX += this.step;
    console.log(this.step);
    return pipe;
  };

  PipeManager.prototype.update = function(viewportX) {
    var pipe, _i, _len, _ref;
    while (this.freePairs.length > 0) {
      this.pipes.push(this.genPipe());
    }
    _ref = this.pipes;
    for (_i = 0, _len = _ref.length; _i < _len; _i++) {
      pipe = _ref[_i];
      pipe.screenX = pipe.x - viewportX;
      $("#" + pipe.pair.id).css('left', pipe.screenX * pixel.size);
    }
    while (this.pipes.length > 0 && this.pipes[0].screenX < -10) {
      console.log(this.pipes);
      this.freePairs.push(this.pipes[0].pair);
      console.log(this.freePairs);
      this.pipes.shift();
      break;
    }
  };

  return PipeManager;

})();

pipe = {
  distance: 56,
  gap: 51,
  width: 28,
  topHeight: 11
};

stage = {
  g: 600,
  height: pipe.gap * 4,
  width: (pipe.distance + pipe.width) * 2
};

bird = {
  size: 15,
  pos: {
    x: 0,
    x0: 0,
    y0: stage.height / 2,
    y: stage.height / 2
  },
  v: {
    x: 60,
    y: 0,
    y0: 180
  },
  screenX: pipe.distance
};

bird.radius = bird.size / 2;

pixel = {
  size: 3
};

$('#bird').css('height', (bird.size * pixel.size) + 'px');

$('#bird').css('width', (bird.size * pixel.size) + 'px');

$('#bird').css('left', (bird.screenX * pixel.size - bird.radius) + 'px');

$('.pipe').css('width', (pipe.width * pixel.size) + 'px');

$('.pipe').css('height', (stage.height * pixel.size) + 'px');

$('.pipe.up').css('top', (pipe.gap * pixel.size) + 'px');

$('.pipe.down').css('top', -1 * (stage.height * pixel.size) + 'px');

$('#stage').css('height', (stage.height * pixel.size) + 'px');

$('#stage').css('width', (stage.width * pixel.size) + 'px');

freePairs = $.makeArray($('.pair'));

startTime = (new Date()).getTime();

theta = function(dx, dy) {
  var t;
  t = dy / (Math.abs(dx) + Math.abs(dy));
  if (t > 0) {
    return t * 90;
  } else {
    return 360 + t * 90;
  }
};

onFrame = function(repeat) {
  var angle, currentTime, lastTime, t;
  currentTime = (new Date()).getTime();
  t = (currentTime - startTime) / 1000;
  bird.pos.y = bird.pos.y0 + bird.v.y * t + 0.5 * stage.g * Math.pow(t, 2);
  bird.pos.x = bird.pos.x0 + bird.v.x * t;
  lastTime = currentTime;
  $('#bird').css('top', (bird.pos.y * pixel.size - bird.radius) + 'px');
  angle = theta(bird.v.x, bird.v.y + t * stage.g);
  pipeMan.update(bird.pos.x - bird.screenX);
  if (repeat) {
    if (bird.pos.y > stage.height - bird.radius) {
      flap();
      bird.pos.y0 = stage.height - bird.radius;
    }
    requestAnimateFrame(function() {
      onFrame(true);
    });
  }
};

flap = function() {
  if (bird.pos.y > bird.radius) {
    onFrame(false);
    startTime = (new Date()).getTime();
    bird.pos.y0 = bird.pos.y;
    bird.pos.x0 = bird.pos.x;
    return bird.v.y = -bird.v.y0;
  }
};

$('#stage').click(flap);

$(document).keydown(function(event) {
  return flap();
});

pipeMan = new PipeManager(2 * pipe.gap, 2 * stage.width, pipe.distance + pipe.width, freePairs);

requestAnimateFrame(function() {
  onFrame(true);
});

MainCtrl = function($scope, $timeout) {};
